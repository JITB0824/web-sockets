<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Socket Server</title>
</head>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
    input.right {
        float: right;
        background-color: orange;
        padding: 15px 15px;
        font-size: 20px;
    }

    input.right2 {
        float: right;
        background-color: green;
        padding: 10px 10px;
        font-size: 15px;
    }
</style>

<body>
    <script>
        var ws = new WebSocket("ws://localhost:3000")
        function openws() {
            var ws = new WebSocket("ws://localhost:3000")
        }


        ws.onmessage = message => {
            console.log('We recieved a message: ', message)

            var jsonparse = JSON.parse(message.data)
            if (jsonparse.title == "chart-data") {
                updateData(jsonparse.openPinData)
            }
            if (jsonparse.title == "Connected") {
                connected()
            }
        }

        ws.onclose = function () {
            console.log("disconnected and changing button")
            var button = document.getElementById("site-status")
            button.style = "background-color: red"
            button.value = "Disconnected"
            button = document.getElementById("reconnect-button")
            button.style = "background-color: green"
            button.value = "Reconnect"
            button.onclick = function () { openws() }
        }


        //Update the HTML so the status shows green
        function connected() {
            console.log("connected and changing button")
            var button = document.getElementById("site-status")
            button.style = "background-color: green"
            button.value = "Connected"
            button = document.getElementById("reconnect-button")
            button.style = "background-color: red"
            button.value = "Disconnect"
            button.onclick = function () { closeWebSocket() }
        }



        chartUpdateJSON = JSON.stringify({
            "title": "chart-update",
            "message": "This is chart 1!"
        })

        function gpioOpen() {
            gpioOpenJSON = JSON.stringify({
                "title": "open-pin",
                "gpioPin": JSON.parse(document.getElementById('openPinField').value)
            })
            console.log("sending open pin: " + JSON.parse(gpioOpenJSON).gpioPin)
            ws.send(gpioOpenJSON)
            document.getElementById('openPinField').value = null
        }

        function gpioClose() {
            gpioCloseJSON = JSON.stringify({
                "title": "close-pin",
                "gpioPin": JSON.parse(document.getElementById('closePinField').value)
            })
            console.log("sending closed pin: " + JSON.parse(gpioCloseJSON).gpioPin)
            ws.send(gpioCloseJSON)
            document.getElementById('closePinField').value = null
        }

        function gpioCloseAll() {
            gpioCloseAllJSON = JSON.stringify({
                "title": "close-all"
            })
            console.log("Closing all pins")
            ws.send(gpioCloseAllJSON)
        }

        function requestUpdateData() {
            if (ws.readyState === WebSocket.OPEN) {
                console.log("Asking for updated data")
                ws.send(JSON.stringify({
                    "title": "update-data"
                }))
            }
        }

        function gpioOpenConnectedPins() {
            gpioOpenConnectedJSON = JSON.stringify({
                "title": "open-connected-pins",
            })
            console.log("Requesting open connected pins")
            ws.send(gpioOpenConnectedJSON)
        }

        function closeWebSocket() {
            console.log("Closing websocket")
            ws.close()
        }







        //UPDATE PAGE
        //
        //
        setInterval(requestUpdateData, 500)
        function updateData(openPinData) {

            openPins = new Array()
            openPinStatus = new Array()

            for (var i = 0; i < openPinData.length; i++) {
                openPins.push(openPinData[i][0])
                openPinStatus.push(openPinData[i][1])
            }
            document.getElementById("openPins").value = openPins



            //check if graphs need to be created
            var pinAlreadyAdded = false
            for (var i = 0; i < openPins.length; i++) {
                for (var j = 0; j < openPinHTMLAdded.length; j++) {
                    if (openPins[i] == openPinHTMLAdded[j]) {
                        pinAlreadyAdded = true
                    }
                }
                if (pinAlreadyAdded) {

                } else {
                    console.log("creating chart for pin: " + openPins[i])
                    createChart(openPins[i])
                    openPinHTMLAdded.push(openPins[i])
                }

                pinAlreadyAdded = false
            }



            //Check if graphs need to be removed
            var pinStillHere = false
            for (var i = 0; i < openPinHTMLAdded.length; i++) {
                for (var j = 0; j < openPins.length; j++) {
                    if (openPins[j] == openPinHTMLAdded[i]) {
                        pinStillHere = true
                    }
                }
                if (pinStillHere) {

                } else {
                    console.log("removing chart for pin: " + openPinHTMLAdded[i])
                    removeChart(openPinHTMLAdded[i])
                    openPinHTMLAdded.splice(i, 1)
                }

                pinStillHere = false
            }


            //Set color of recording status
            for (var i = 0; i < openPins.length; i++) {
                if (openPinStatus[i] == true) {
                    button = document.getElementById(openPins[i])
                    button.style.background = "green"
                    button.innerHTML = ("Recording")
                } else {
                    button = document.getElementById(openPins[i])
                    button.style.background = "red"
                    button.innerHTML = ("Not recording")
                }
            }

        }




        //CHARTS
        //
        //
        //Create an array to track what graphs are open
        openPinHTMLAdded = new Array()


        //Temp data array
        var xArray = [50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150];
        var yArray = [7, 8, 8, 9, 9, 9, 10, 11, 14, 14, 15];
        var data = [{
            x: xArray,
            y: yArray,
            mode: "markers",
            type: "scatter"
        }];


        //Handle creating charts/buttons per open thread
        function createChart(pin) {
            let button = document.createElement("button")
            newID = JSON.stringify(pin)

            button.innerHTML = "Not recording"
            button.onclick = function () { changeRecordingStatus(pin) }

            var layout = {
                xaxis: { range: [40, 160], title: "x axis" },
                xaxis: { range: [5, 16], title: "x axis" },
                title: "GRAPHS!!"
            }
            let plot = document.createElement("chart")
            plotid = "Plot" + newID

            let label = document.createElement("H3")
            var text = document.createTextNode("Pin: " + newID)
            label.appendChild(text)

            document.body.appendChild(label)
            document.body.appendChild(plot)
            document.body.appendChild(button)
            label.id = "Label" + newID
            button.id = newID
            plot.id = "Plot" + newID
            Plotly.newPlot(plotid, data, layout)
        }

        //Handle removing charts/buttons per
        function removeChart(pin) {
            var button = document.getElementById(JSON.stringify(pin))
            button.remove()
            var plot = document.getElementById("Plot" + JSON.stringify(pin))
            plot.remove()
            var label = document.getElementById("Label" + JSON.stringify(pin))
            label.remove()
        }

        function changeRecordingStatus(pin) {
            console.log("Changing recording status of pin: " + pin)
            var changeRecordingStatus = JSON.stringify({
                "title": "change-recording-status",
                "gpioPin": pin
            })
            ws.send(changeRecordingStatus)
        }


    </script>

    <h2>GPIO Pin Management</h2>
    <input type="button" id="site-status" value="Connecting..." class="right"><br><br><br><br>
    <input type="button" id="reconnect-button" value="Reconnect" class="right2">
    <h3>Open Pins</h3>
    <input type="text" id="openPins"><br><br>

    <h3>Manage Pins</h3>
    <form>
        <label for="openPinField">Open new pin:</label><br>
        <input type="text" id="openPinField" name="openPinField">
        <input type="button" value="Submit" onclick="gpioOpen()"><br><br>
        <input type="button" value="Open connected pins" onclick="gpioOpenConnectedPins()"
            style="background-color: green"><br><br><br>
    </form>

    <form>
        <label for="closePinField">Close open pin:</label><br>
        <input type="text" id="closePinField" name="closePinField">
        <input type="button" value="Submit" onclick="gpioClose()"><br><br>
        <input type="button" value="Close all pins" onclick="gpioCloseAll()" style="background-color: orange">
    </form><br><br>

    <h2>Incoming GPIO Data</h2>


</body>

</html>